# Rust on ESP32-C6

## Prerequisites
- Install rust via `curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh`
- restart restart terminal to source rust `. "$HOME/.cargo/env"`
- get ESP Rust Toolchain `cargo install espup`
- setup ESP Rust Toolchain `espup install`
- add `'. /home/robby/export-esp.sh'` to bashrc
- install the template generator `cargo install esp-generate `
- `cargo install espflash --locked`
- `curl --proto '=https' --tlsv1.2 -LsSf https://github.com/probe-rs/probe-rs/releases/latest/download/probe-rs-tools-installer.sh | sh`
- `cargo install esp-config --features=tui --locked`

### For ESP-IDF-HAL Usage
- `sudo apt-get install git wget flex bison gperf python3 python3-pip python3-venv cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0`
- Do not follow the whole ESP-IDF Installation and instead
- install rust (done)
```sh
cargo install cargo-generate
cargo install ldproxy
# installed previoulsly:
# cargo install espup
# cargo install espflash
# cargo install cargo-espflash # Optional
# sudo apt-get install libudev-dev
```

Finally initialize the folder by executing `cargo generate esp-rs/esp-idf-template cargo`

### VSCode Extensions
- rust-analyzer
- Wokwi with account and 30day license
- dependi for crates mgmt


## Setup via esp-generate

Use `esp-generate --chip esp32c6 myproject` and follow configuration as necessary with probe-rs

## Run

`cargo run` build the binaries that can then be simulated via Wokwi


## Useful Links
- [Three LED on Xiao ESP32-C6](https://wokwi.com/projects/411265368570177537)
- [Wiki - XIAO ESP32-C6 Getting Started ](https://wiki.seeedstudio.com/xiao_esp32c6_getting_started/)
- [Wokwi ESP32 Guide](https://docs.wokwi.com/guides/esp32)

### ESP-IDF
- [ESP32-C6 IDF API Reference](https://docs.espressif.com/projects/esp-idf/en/latest/esp32c6/api-reference/index.html)
- [Github ESP-IDF-HAL Crate](https://github.com/esp-rs/esp-idf-hal?tab=readme-ov-file)

## Architectural Overview of Embedded Rust via ESP-IDF

```mermaid
graph TB
    subgraph "Application Layer"
        APP[Your Rust Application<br/><i>Business logic, sensor reading loops</i>]
    end
    
    subgraph "High-Level Services"
        SVC[esp-idf-svc<br/><i>WiFi, MQTT, HTTP server, NVS storage</i>]
    end
    
    subgraph "Device Drivers - Community Ecosystem"
        DRIVERS[Device Drivers from crates.io<br/><i>embedded_aht20, dht-embedded, bme280, etc.</i><br/><i>Platform-independent sensor drivers</i>]
    end
    
    subgraph "Hardware Abstraction"
        HAL[esp-idf-hal<br/><i>Safe Rust wrappers: GPIO, SPI, I2C, UART, PWM</i>]
        EHAL[embedded-hal traits<br/><i>Standard interfaces: InputPin, OutputPin,</i><br/><i>SpiDevice, I2cDevice - work across all MCUs</i>]
        ESVC[embedded-svc traits<br/><i>Standard service interfaces</i>]
    end
    
    subgraph "Bindings Layer"
        SYS[esp-idf-sys<br/><i>Unsafe FFI bindings generated by bindgen</i><br/><i>Direct access to all ESP-IDF C functions</i>]
    end
    
    subgraph "C Framework Layer"
        IDF[ESP-IDF Framework<br/><i>Espressif's official framework: WiFi/BLE stacks,</i><br/><i>peripheral drivers, power management</i>]
        ARDUINO[Arduino Framework / <br/><i>Optional compatibility layer on top of ESP-IDF</i><br/><i>digitalWrite, Serial.print, etc.</i>]
    end
    
    subgraph "RTOS Layer"
        RTOS[FreeRTOS<br/><i>Real-time kernel: task scheduling, queues,</i><br/><i>mutexes, semaphores, timers</i>]
    end
    
    subgraph "Hardware Layer"
        HW[ESP32-C6 Hardware<br/><i>Memory-mapped registers, GPIO pins, SPI/I2C</i><br/><i>controllers, WiFi/BLE radio, ADC, timers</i>]
        SENSOR[External Hardware<br/><i>AHT20 humidity sensor, displays,</i><br/><i>buttons, LEDs, motors, etc.</i>]
    end
    
    APP --> SVC
    APP --> DRIVERS
    APP --> HAL
    SVC --> HAL
    SVC --> SYS
    SVC -.implements.-> ESVC
    DRIVERS --> EHAL
    HAL --> SYS
    HAL -.implements.-> EHAL
    SYS --> IDF
    IDF --> RTOS
    ARDUINO --> IDF
    RTOS --> HW
    IDF --> HW
    HW <--> SENSOR
    
    style APP fill:#e1f5ff
    style SVC fill:#b3e5fc
    style DRIVERS fill:#c8e6c9
    style HAL fill:#81d4fa
    style SYS fill:#4fc3f7
    style IDF fill:#29b6f6
    style ARDUINO fill:#ffb74d
    style RTOS fill:#039be5
    style HW fill:#0277bd
    style SENSOR fill:#66bb6a
    style EHAL fill:#fff9c4
    style ESVC fill:#fff59d
```

## Hardware Overview
- ESP32-C6 from seeedstudio xiao series
  - 160MHz 320KB ROM, 512KB SRAM
  - RiscV core, ble, wifi, thread
  - 20mHz low power core
- Xiao Starter Kit
  - Xiao Expansion Board
    - OLED Display: SSD1306
    - clock: PCF8563
  - several other Grove Sensors
- ePaper Driver board
  - battery & power mgmt: ETA9740
  - 2"-bw-epaper display: ssd1680
- xiao ml kit:
  - https://www.mlsysbook.ai/contents/labs/seeed/xiao_esp32s3/setup/setup.html
  - ESP32-S3 xtensa-based chip
    - dual core 240MHz
    - 8MB PSRAM 8MB Flash, 32GB SD-card 
    - wifi, 14uA deep sleep
  - 6-axis-imu: LSM6DS3TR-C 0x6a
  - camera: OV2640 
  - OLED: SSD1306 0x3c

next:
- esp32-p4
  - dual core 400MHz
  - Memory 
    - 128 KB of high-performance system ROM
    - 768 KB of high-performance (HP) L2 memory (L2MEM)
    - 32 KB of low-power (LP) SRAM
    - 32 MB PSRAM stacked in the package, and the QSPI interface is connected to 16MB Nor Flash
  - additional ESP32-C6 for connectivity
  - PoE, Mipi-CSI, Mipi-DSI
